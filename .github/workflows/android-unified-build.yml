# Nome do Workflow: Pipeline Profissional Android
# DescriÃ§Ã£o: Este workflow automatiza o processo de build e validaÃ§Ã£o de um projeto Android.
# Ele Ã© acionado por pushes na branch principal com alteraÃ§Ãµes relevantes ou manualmente.
# O processo Ã© dividido em etapas claras para fÃ¡cil acompanhamento na interface do GitHub.

name: Android Professional Pipeline

# Gatilhos (Triggers) para executar o workflow
on:
  push:
    branches: [ main, master ]
    paths:
      - '**.kt'        # Arquivos Kotlin
      - '**.gradle*'   # Arquivos de build do Gradle
      - '**.xml'       # Arquivos de recursos e manifestos
      - 'gradle/**'    # ConfiguraÃ§Ãµes do Gradle
  workflow_dispatch: # Permite execuÃ§Ã£o manual pela interface do GitHub

# Controle de ConcorrÃªncia: Cancela execuÃ§Ãµes antigas se um novo push for feito.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pipeline:
    runs-on: ubuntu-latest # MÃ¡quina virtual que executarÃ¡ o job
    timeout-minutes: 45     # Tempo mÃ¡ximo para a execuÃ§Ã£o do job

    steps:
      # ETAPA 1: OBTENÃ‡ÃƒO DO CÃ“DIGO-FONTE
      # Baixa o cÃ³digo do repositÃ³rio para a mÃ¡quina virtual de execuÃ§Ã£o.
      - name: 1. Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Baixa apenas o commit mais recente para agilizar o processo.

      # ETAPA 2: CONFIGURAÃ‡ÃƒO DO AMBIENTE DE BUILD
      # Instala o Java Development Kit (JDK) necessÃ¡rio para o Gradle e o Android.
      - name: 2. Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle' # Habilita o cache automÃ¡tico do Gradle.

      # Instala o Android SDK e as ferramentas de build necessÃ¡rias.
      - name: 3. Configurar Android SDK
        uses: android-actions/setup-android@v3

      # ETAPA 3: OTIMIZAÃ‡ÃƒO DE PERFORMANCE (CACHE)
      # Armazena em cache as dependÃªncias do Gradle e compilaÃ§Ãµes do Kotlin para acelerar builds futuros.
      - name: 4. Cache de DependÃªncias Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle/kotlin
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      # ETAPA 4: CONFIGURAÃ‡ÃƒO DO GRADLE
      # Prepara o ambiente para a execuÃ§Ã£o do Gradle, definindo propriedades de performance e localizaÃ§Ã£o do SDK.
      - name: 5. Configurar Propriedades do Gradle
        run: |
          echo "ðŸ”§ Configurando ambiente Gradle..."
          chmod +x gradlew # DÃ¡ permissÃ£o de execuÃ§Ã£o ao Gradle Wrapper.
          echo "sdk.dir=$ANDROID_HOME" > local.properties # Cria o arquivo local.properties apontando para o SDK.
          mkdir -p ~/.gradle
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties # Ativa build paralelo.
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties   # Ativa cache do Gradle.
          echo "âœ… ConfiguraÃ§Ã£o do Gradle concluÃ­da."

      # ETAPA 5: VALIDAÃ‡ÃƒO DE QUALIDADE DO CÃ“DIGO
      # Executa a anÃ¡lise de Lint para verificar potenciais erros e problemas de qualidade no cÃ³digo.
      - name: 6. Executar AnÃ¡lise de Lint
        run: |
          echo "ðŸ” Iniciando anÃ¡lise de Lint..."
          ./gradlew lintDebug --stacktrace
          echo "âœ… AnÃ¡lise de Lint concluÃ­da."

      # ETAPA 6: COMPILAÃ‡ÃƒO E GERAÃ‡ÃƒO DOS BINÃRIOS (APKs)
      # Compila o cÃ³digo e gera os pacotes de aplicaÃ§Ã£o (APKs) para as variantes debug.
      - name: 7. Compilar APKs Debug
        run: |
          echo "ðŸ› ï¸ Iniciando a compilaÃ§Ã£o dos APKs..."
          ./gradlew :app:universal:assembleDebug :app:m3u-extension:assembleDebug \
            --no-daemon \
            -Dkotlin.incremental=true \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseParallelGC"
          echo "âœ… CompilaÃ§Ã£o finalizada com sucesso."

      # ETAPA 7: PREPARAÃ‡ÃƒO DOS ARTEFATOS PARA UPLOAD
      # Organiza os APKs gerados em um diretÃ³rio temporÃ¡rio para facilitar o upload.
      - name: 8. Preparar Artefatos para Upload
        run: |
          echo "ðŸ“¦ Preparando os binÃ¡rios gerados..."
          mkdir -p output_staging
          # O comando 'find' Ã© robusto para localizar todos os APKs, independentemente do local exato de geraÃ§Ã£o.
          find . -name "*.apk" -type f -exec cp {} output_staging/ \;
          echo "Arquivos encontrados para upload:"
          ls -lh output_staging/

      # ETAPA 8: PERSISTÃŠNCIA DOS ARTEFATOS
      # Faz o upload dos APKs para que possam ser baixados como um artefato da execuÃ§Ã£o.
      - name: 9. Fazer Upload dos APKs
        uses: actions/upload-artifact@v4
        with:
          name: play-app-production-ready
          path: output_staging/*.apk
          retention-days: 2
          compression-level: 9
          if-no-files-found: error # Falha o job se nenhum arquivo for encontrado.

      # ETAPA 9: GERAÃ‡ÃƒO DE RESUMO DA EXECUÃ‡ÃƒO
      # Cria um resumo visual no final da pÃ¡gina do Job, listando os artefatos e seus tamanhos.
      # A condiÃ§Ã£o 'if: always()' garante que esta etapa execute mesmo que outras falhem.
      - name: 10. ðŸ“‹ Gerar Resumo da Build
        if: always()
        run: |
          echo "## ðŸš€ Resumo da Build Android" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Verifica se o diretÃ³rio de saÃ­da existe e nÃ£o estÃ¡ vazio.
          if [ -d "output_staging" ] && [ "$(ls -A output_staging)" ]; then
            echo "### âœ… Build ConcluÃ­da com Sucesso!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Artefatos (APKs) Gerados:" >> $GITHUB_STEP_SUMMARY
            echo "| Nome do Arquivo | Tamanho |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY
            # Itera sobre os arquivos no diretÃ³rio para criar a tabela no resumo.
            for file in output_staging/*; do
              filename=$(basename "$file")
              filesize=$(ls -lh "$file" | awk '{print $5}')
              echo "| $filename | $filesize |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### âŒ Falha na Build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Nenhum artefato APK foi encontrado. Verifique os logs das etapas anteriores para mais detalhes." >> $GITHUB_STEP_SUMMARY
          fi