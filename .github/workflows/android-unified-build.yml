# Pipeline de Build Profissional - IPTV PLAY V2
# CompatÃ­vel com: GitHub Actions (ubuntu-latest, 7GB RAM) + Local Windows
# Gera APKs Release assinados com a keystore configurada nos Secrets.

name: Android Production Build

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.kt'
      - '**.gradle*'
      - '**.xml'
      - 'gradle/**'
      - '.github/workflows/android-unified-build.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Sign APKs
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 1. Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: 3. Configurar Android SDK
        uses: android-actions/setup-android@v3

      - name: 4. Cache Gradle e DependÃªncias
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: gradle-${{ runner.os }}-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ASSINATURA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 5. Preparar Keystore de Assinatura
        run: |
          echo "ðŸ” Configurando keystore..."
          if [ -n "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > "$GITHUB_WORKSPACE/release-signing.keystore"
            echo "KEYSTORE_PATH=$GITHUB_WORKSPACE/release-signing.keystore" >> $GITHUB_ENV
            echo "âœ… Keystore decodificada dos Secrets."
          elif [ -f "meu-app.keystore" ]; then
            echo "KEYSTORE_PATH=$GITHUB_WORKSPACE/meu-app.keystore" >> $GITHUB_ENV
            echo "âš ï¸ Usando meu-app.keystore do repositÃ³rio (fallback)."
          else
            echo "âŒ ERRO: Nenhuma keystore encontrada!" && exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AMBIENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 6. Configurar Ambiente de Build
        run: |
          chmod +x gradlew

          # Definir o SDK path para o Gradle
          echo "sdk.dir=$ANDROID_HOME" > local.properties

          # Injetar credenciais de assinatura via local.properties
          STORE_PASS="${{ secrets.RELEASE_STORE_PASSWORD }}"
          KEY_ALIAS="${{ secrets.RELEASE_KEY_ALIAS }}"
          KEY_PASS="${{ secrets.RELEASE_KEY_PASSWORD }}"

          # Usar valores padrÃ£o se os Secrets nÃ£o estiverem configurados
          echo "RELEASE_STORE_FILE=${KEYSTORE_PATH}" >> local.properties
          echo "RELEASE_STORE_PASSWORD=${STORE_PASS:-Wa97951211@}" >> local.properties
          echo "RELEASE_KEY_ALIAS=${KEY_ALIAS:-meu_alias}" >> local.properties
          echo "RELEASE_KEY_PASSWORD=${KEY_PASS:-Wa97951211@}" >> local.properties

          # Sobrescrever gradle.properties para o ambiente CI com mais memÃ³ria
          # GitHub Actions tem 7GB de RAM disponÃ­veis no runner ubuntu-latest
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xms512m -Xmx5g -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -Dfile.encoding=UTF-8
          kotlin.daemon.jvm.options=-Xmx2g -XX:MaxMetaspaceSize=512m
          org.gradle.daemon=false
          org.gradle.workers.max=2
          org.gradle.caching=true
          org.gradle.parallel=true
          org.gradle.configuration-cache=false
          kotlin.incremental=false
          android.useAndroidX=true
          android.enableJetifier=false
          android.enableR8.fullMode=true
          org.gradle.vfs.watch=false
          ndkVersion=23.1.7779620
          EOF

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 7. Build APK Universal (Smartphone + TV)
        run: |
          echo "ðŸ—ï¸ Compilando app:universal..."
          ./gradlew :app:universal:assembleRelease \
            --no-daemon \
            --stacktrace \
            --console=plain

      - name: 8. Build APK Extension
        run: |
          echo "ðŸ§© Compilando app:m3u-extension..."
          ./gradlew :app:m3u-extension:assembleRelease \
            --no-daemon \
            --stacktrace \
            --console=plain

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ARTEFATOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 9. Coletar APKs Gerados
        run: |
          mkdir -p final_apks
          echo "ðŸ“¦ APKs encontrados:"
          find . -path "*/build/outputs/apk/release/*.apk" -not -path "*/build/python/*" | while read apk; do
            echo "  â†’ $apk"
            cp "$apk" "final_apks/$(basename "$apk")"
          done
          ls -lh final_apks/ || echo "âš ï¸ Nenhum APK gerado!"

      - name: 10. Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: IPTVPLAYV2-Release-APKs
          path: final_apks/*.apk
          retention-days: 7
          if-no-files-found: error

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RELATÃ“RIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: 11. ðŸ“‹ RelatÃ³rio Final
        if: always()
        run: |
          echo "## ðŸ“± IPTV PLAY V2 - RelatÃ³rio de Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | InformaÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Runner | ubuntu-latest |" >> $GITHUB_STEP_SUMMARY
          echo "| â˜• Java | 21 (Temurin) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "final_apks" ] && [ "$(ls -A final_apks 2>/dev/null)" ]; then
            echo "### âœ… APKs Gerados com Sucesso!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| MÃ³dulo | Arquivo | Tamanho |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
            for file in final_apks/*; do
              name=$(basename "$file")
              size=$(ls -lh "$file" | awk '{print $5}')
              [[ "$name" == *"extension"* ]] && module="ðŸ§© Extension" || module="ðŸ“± Universal"
              echo "| $module | \`$name\` | **$size** |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> âœ… APKs assinados e prontos para distribuiÃ§Ã£o. Baixe na aba **Artifacts** acima." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build FALHOU" >> $GITHUB_STEP_SUMMARY
            echo "Nenhum APK foi gerado. Revise os logs das etapas 7 e 8." >> $GITHUB_STEP_SUMMARY
          fi