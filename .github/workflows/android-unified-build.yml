# Pipeline Ultra-Lean - IPTV PLAY V2
# Foco: Estabilidade e Baixo Consumo de Mem√≥ria (M√≠nimo de Recursos)

name: Android Production Build (Lean)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Sign APKs (Sequential)
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: 1. Checkout do C√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: 3. Configurar Android SDK
        uses: android-actions/setup-android@v3

      - name: 4. Preparar Keystore
        run: |
          if [ -n "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
            echo "RELEASE_STORE_FILE=$GITHUB_WORKSPACE/release.keystore" >> local.properties
          else
            echo "RELEASE_STORE_FILE=../../meu-app.keystore" >> local.properties
          fi
          echo "RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD || 'Wa97951211@' }}" >> local.properties
          echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS || 'meu_alias' }}" >> local.properties
          echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD || 'Wa97951211@' }}" >> local.properties

      - name: 5. Build M√≥dulo Universal (Sequential Step 1)
        run: |
          chmod +x gradlew
          echo "üèóÔ∏è Compilando Universal..."
          ./gradlew :app:universal:assembleRelease \
            --no-daemon \
            --no-parallel \
            -Dorg.gradle.workers.max=1 \
            -Dorg.gradle.jvmargs="-Xmx3g" \
            --console=plain

      - name: 6. Limpar Cache Tempor√°rio (Save Disk/RAM)
        run: ./gradlew clean :app:universal:assembleRelease --no-daemon 2>/dev/null || true

      - name: 7. Build M√≥dulo Extension (Sequential Step 2)
        run: |
          echo "üèóÔ∏è Compilando Extension..."
          ./gradlew :app:m3u-extension:assembleRelease \
            --no-daemon \
            --no-parallel \
            -Dorg.gradle.workers.max=1 \
            -Dorg.gradle.jvmargs="-Xmx3g" \
            --console=plain

      - name: 8. Coletar e Upload Artefatos
        run: |
          mkdir -p final_apks
          find . -path "*/outputs/apk/release/*.apk" -exec cp {} final_apks/ \;
          ls -lh final_apks/

      - name: 9. Upload Final
        uses: actions/upload-artifact@v4
        with:
          name: IPTVPLAYV2-Lean-APKs
          path: final_apks/*.apk