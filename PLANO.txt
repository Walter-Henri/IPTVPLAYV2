IPTV com Extração de Lives do YouTube – Arquitetura Completa
Sistema de dois aplicativos Android – Extração M3U8 + Player Universal
Versão do Documento: 2026.02
Data de atualização: fevereiro de 2026
Status: Documento Oficial Consolidado – Referência única para implementação e refatoração

1. Sumário Executivo

Sistema composto por dois aplicativos Android que trabalham em conjunto para permitir a reprodução de lives do YouTube em formato M3U8/HLS dentro de um player IPTV profissional, com bypass automático de restrições do YouTube.

Aplicativo          | Nome sugerido                     | Pacote sugerido                  | Função principal                              | Responsabilidade principal
--------------------|-----------------------------------|----------------------------------|-----------------------------------------------|-----------------------------------------------------
APP 1               | Universal IPTV Player             | com.empresa.iptv.player          | Reproduzir qualquer stream M3U8/HLS           | Player multi-engine + interface Phone/TV
APP 2               | YouTube Stream Extractor (YT-M3U) | com.empresa.yt.m3uextractor      | Extrair URL M3U8 de lives do YouTube          | Manutenção de sessão, PO Tokens, cookies, yt-dlp

Objetivo principal:
Permitir que o usuário compartilhe uma live do YouTube e a assista imediatamente em um player IPTV robusto, com headers corretos, sessão persistente e recuperação automática de expiração.

2. Arquitetura Geral do Sistema

2.1 Diagrama de Alto Nível (representação textual)

Sessão Compartilhada (Background Session Manager – sempre ativo)
|
├─ Invisible WebView (processo separado / always-on)
│   ↓ (navega e aquece sessão)
├─ Token Extractor (JavaScript Bridge / PO Token + visitor_data)
│   ↓
├─ Cookie Sync Engine (formato Netscape → arquivo ou SharedPrefs)
│   ↓
└─ SessionContentProvider
      │
      ├─ leitura → APP 1 (Reprodutor)
      └─ leitura + escrita → APP 2 (Extrator)

                 ┌───────────────────────────────┴───────────────────────────────┐
                 │                                                               │
        ┌────────▼──────────────┐                                       ┌────────▼──────────────┐
        │ APP 1                 │                                       │ APP 2                 │
        │ Universal IPTV Player │◄─────────────── Intent Rico ──────────┤ YT Stream Extractor   │
        └───────────────────────┘          (ACTION_VIEW ou custom)       └───────────────────────┘
                 │                                                                   │
                 └─────────────────────── Reproduz M3U8 com headers ──────────────────┘

2.2 Princípios de Design

- Separação estrita de responsabilidades
- Comunicação assíncrona via Intent + ContentProvider
- Sessão centralizada e resiliente (tokens, cookies, visitor_data)
- Manutenção periódica via WorkManager
- Economia de bateria e dados
- Fallbacks e mensagens claras quando parceiro não instalado

3. Detalhamento dos Aplicativos

3.1 APP 1 – Universal IPTV Player

Funções principais:
- Reproduzir streams M3U8/HLS de qualquer origem
- Suporte a múltiplos engines: ExoPlayer, VLC, MPV, WebView
- Interface otimizada para Android Phone e Android TV (Leanback)
- Lista de canais/favoritos + EPG básico
- Recepção de Intents ricos com headers e metadados

Componentes chave:
- PlayerManager (Strategy Pattern)
- SessionClient (consulta ContentProvider)
- IntentParser (headers + session data)
- Configurações de engine preferido

3.2 APP 2 – YouTube Stream Extractor

Funções principais:
- Receber share/link do YouTube
- Manter sessão YouTube válida (WebView invisível)
- Extrair PO Token, visitor_data, cookies
- Executar yt-dlp com parâmetros otimizados
- Gerar Intent rico para o player
- Rodar em background/service

Componentes chave:
- BackgroundSessionService
- TokenExtractor (JS injection)
- CookieSyncEngine
- YtDlpWrapper
- SessionContentProvider (escrita)

4. Fluxos Principais

4.1 Fluxo Principal (Share → Extração → Playback)

YouTube app → Compartilhar live → "Abrir com YT-M3U" (APP 2)
          │
          ▼
APP 2 (background):
  • Verifica/inicia BackgroundSessionService
  • Garante sessão válida (< 6–8h)
  • Executa yt-dlp --get-url + --cookies + --user-agent
  • Obtém URL M3U8 + headers
          │
          ▼
Dispara Intent rico para APP 1:
  • ACTION_VIEW ou custom action
  • Extras: url, User-Agent, Referer, Cookie, visitor_data, po_token, title, thumbnail
          │
          ▼
APP 1:
  • Parseia Intent
  • Seleciona engine
  • Injeta headers na requisição
  • Inicia reprodução

4.2 Fluxo de Manutenção Automática

WorkManager (periodic 15–30 min)
  ↓
Se sessão foi usada recentemente:
  • Navega para vídeo aleatório → aquece
  • Extrai novos PO Token + cookies
  • Atualiza ContentProvider
  • Envia broadcast "SESSION_UPDATED"
          ↓
APP 1 (se aberto) → atualiza headers para próximas trocas de canal

5. Implementação Técnica – Trechos Críticos

5.1 Manifest – Intent Filters (exemplo simplificado)

APP 2 (Extrator):

<activity android:name=".ExtractActivity" android:exported="true" android:theme="@android:style/Theme.Translucent.NoTitleBar">
    <!-- Share de texto -->
    <intent-filter>
        <action android:name="android.intent.action.SEND" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:mimeType="text/plain" />
    </intent-filter>
    <!-- Links diretos YouTube -->
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data android:scheme="https" android:host="www.youtube.com" android:pathPrefix="/watch" />
        <data android:scheme="https" android:host="youtu.be" />
    </intent-filter>
</activity>

APP 1 (Player):

<activity android:name=".PlayerActivity" android:exported="true">
    <!-- Streams M3U8 -->
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:scheme="http"  android:mimeType="application/x-mpegURL" />
        <data android:scheme="https" android:mimeType="application/x-mpegURL" />
    </intent-filter>
    <!-- Intent custom -->
    <intent-filter>
        <action android:name="com.empresa.PLAY_STREAM" />
        <category android:name="android.intent.category.DEFAULT" />
    </intent-filter>
</activity>

5.2 Exemplo de Intent Rico (Kotlin – APP 2 → APP 1)

val intent = Intent().apply {
    action = Intent.ACTION_VIEW
    setDataAndType(Uri.parse(m3u8Url), "application/x-mpegURL")
    setPackage("com.empresa.iptv.player")

    putExtra("User-Agent",     userAgent)
    putExtra("Referer",        "https://www.youtube.com/")
    putExtra("Cookie",         cookieStringNetscape)
    putExtra("visitor_data",   visitorData)
    putExtra("po_token",       poToken)
    putExtra("session_timestamp", System.currentTimeMillis())

    putExtra("title",          videoTitle)
    putExtra("thumbnail",      thumbnailUrl)
    putExtra("channel",        channelName)

    flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK
}
startActivity(intent)

6. Permissões Recomendadas

APP 2 (Extrator):
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />        <!-- opcional -->

APP 1 (Player):
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" /> <!-- opcional -->

7. Checklist de Implementação – Projeto Existente

APP 2 – YouTube Extractor
[ ] Intent-filters para SEND (text/plain) + VIEW (youtube.com / youtu.be)
[ ] BackgroundSessionService + Invisible WebView
[ ] Extração PO Token + visitor_data via JavaScript bridge
[ ] Exportação de cookies no formato Netscape
[ ] Integração com yt-dlp-android
[ ] SessionContentProvider com permissão de escrita
[ ] WorkManager para refresh periódico da sessão
[ ] Construção e disparo de Intent rico para player
[ ] Tratamento de erros (403, 429, timeout, live não iniciada)

APP 1 – Universal IPTV Player
[ ] Intent-filters para M3U8 + action custom
[ ] PlayerManager com Strategy Pattern (ExoPlayer, VLC, MPV, WebView)
[ ] Parser completo de Intent rico (headers + session extras)
[ ] Consulta ao SessionContentProvider
[ ] UI adaptada Phone + Android TV (D-Pad, overscan, Leanback)
[ ] Suporte a lista de canais / favoritos / EPG básico
[ ] Configuração de engine preferido pelo usuário
[ ] Detecção e tratamento de sessão expirada

Integração Geral
[ ] Authorities do ContentProvider iguais nos dois manifests
[ ] BroadcastReceiver para "SESSION_UPDATED"
[ ] Diálogo de fallback quando o app parceiro não está instalado
[ ] Testes com lives longas (>8h) e cenários de expiração

8. Referências Técnicas Principais

- yt-dlp Android wrapper: https://github.com/yausername/youtubedl-android
- Android TV Leanback: https://developer.android.com/training/tv/start/layouts
- EncryptedSharedPreferences: Jetpack Security
- WorkManager: https://developer.android.com/topic/libraries/architecture/workmanager
- App Links / Deep Links: https://developer.android.com/training/app-links

Fim do documento técnico consolidado – versão única e completa
Versão 2026.02
Utilize este arquivo como fonte principal para codificação, refatoração e evolução do projeto.

Boa implementação!