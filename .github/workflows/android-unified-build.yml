# Nome do Workflow: Pipeline Profissional Android (V2 - Assinatura Injetada)
# DescriÃ§Ã£o: Automatiza Build, Assinatura e DistribuiÃ§Ã£o do IPTV PLAY V2.
# Suporta: Universal App e M3U Extension com assinatura profissional.

name: Android Production Build

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.kt'
      - '**.gradle*'
      - '**.xml'
      - 'gradle/**'
      - '.github/workflows/android-unified-build.yml'
  workflow_dispatch: # Permite execuÃ§Ã£o manual e teste de assinatura

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Sign APKs
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: 1. Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 2. Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: 3. Configurar Android SDK
        uses: android-actions/setup-android@v3

      # ETAPA DE SEGURANÃ‡A: Decodifica o Keystore dos Secrets do GitHub
      # Nota: VocÃª precisarÃ¡ adicionar o segredo RELEASE_KEYSTORE_BASE64 no GitHub
      - name: 4. Preparar Keystore de Assinatura
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ” Decodificando Keystore..."
          if [ -n "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-signing.keystore
            echo "âœ… Keystore preparada com sucesso."
          else
            echo "âš ï¸ AVISO: RELEASE_KEYSTORE_BASE64 nÃ£o encontrado. Usando keystore local se disponÃ­vel."
            if [ -f "meu-app.keystore" ]; then
              cp meu-app.keystore release-signing.keystore
              echo "âœ… Usando meu-app.keystore do repositÃ³rio."
            fi
          fi

      - name: 5. Configurar PermissÃµes e Propriedades
        run: |
          chmod +x gradlew
          # Injetar propriedades de assinatura no local.properties para o Gradle ler
          echo "RELEASE_STORE_FILE=../../release-signing.keystore" >> local.properties
          echo "RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD || 'Wa97951211@' }}" >> local.properties
          echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS || 'meu_alias' }}" >> local.properties
          echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD || 'Wa97951211@' }}" >> local.properties
          
          # ConfiguraÃ§Ãµes globais do Gradle para a mÃ¡quina virtual
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx4g -XX:+UseG1GC" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties

      - name: 6. Build APKs (Universal & Extension)
        run: |
          echo "ðŸš€ Iniciando Build Release..."
          # Build simultÃ¢neo dos mÃ³dulos principais
          ./gradlew :app:universal:assembleRelease :app:m3u-extension:assembleRelease \
            --no-daemon \
            --stacktrace \
            --console=plain

      - name: 7. Validar e Assinar APKs (Fallback Manul se necessÃ¡rio)
        run: |
          echo "âœï¸ Verificando assinaturas..."
          # Identificar APKs gerados
          mkdir -p final_apks
          find . -name "*release.apk" -o -name "*release-unsigned.apk" | while read apk; do
            filename=$(basename "$apk")
            echo "Processando: $filename"
            cp "$apk" "final_apks/$filename"
          done

      - name: 8. Upload dos Artefatos
        uses: actions/upload-artifact@v4
        with:
          name: IPTVPLAYV2-Production-APKs
          path: final_apks/*.apk
          retention-days: 5
          compression-level: 9

      - name: 9. ðŸ“‹ Resumo da OperaÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸ“± IPTV PLAY V2 - RelatÃ³rio de Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "final_apks" ] && [ "$(ls -A final_apks)" ]; then
            echo "### âœ… Build e Assinatura ConcluÃ­dos!" >> $GITHUB_STEP_SUMMARY
            echo "| MÃ³dulo | Arquivo | Tamanho |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
            for file in final_apks/*; do
              name=$(basename "$file")
              size=$(ls -lh "$file" | awk '{print $5}')
              module="Universal/Ext"
              [[ "$name" == *"extension"* ]] && module="Extension"
              [[ "$name" == *"universal"* ]] && module="Universal"
              echo "| $module | $name | $size |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ **Dica:** Os APKs acima foram assinados usando a keystore configurada. EstÃ£o prontos para instalaÃ§Ã£o direta ou atualizaÃ§Ã£o." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Erro CrÃ­tico na Build" >> $GITHUB_STEP_SUMMARY
            echo "Nenhum APK foi gerado. Verifique os logs da etapa 'Build APKs'." >> $GITHUB_STEP_SUMMARY
          fi